{#
{% extends 'base.html.twig' %}

{% block title %}Usuarios - GreenHarvest{% endblock %}

{% block breadcrumb %}
    {% set breadcrumb = [
        {'label': 'Inicio', 'url': path('app_home')},
        {'label': 'Usuarios', 'url': path('app_user_index')}
    ] %}
    {% include 'components/_breadcrumb.html.twig' with {'items': breadcrumb} %}
{% endblock %}

{% block body %}
<div class="">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 fw-bold text-success mb-0">Usuarios</h1>
   
  </div>

  <!-- Buscador -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <form method="get" action="{{ path('app_user_index') }}" class="mb-2">
      <div class="input-group">
     
        <input type="text" name="q" value="{{ search|default('') }}" id="query-user" data-cy="query-user"
              class="form-control" placeholder="Buscar por email..." aria-label="Buscar usuario">
        <button class="btn btn-outline-success rounded-0" type="submit" id="btn-query-user" data-cy="btn-query-user">
          <i class="bi bi-search"></i> Buscar
        </button>
      </div>
    </form>
     <a href="{{ path('app_user_new') }}" class="btn btn-outline-success rounded-1 ">
      <i class="bi bi-plus-circle"></i> Añadir Usuario
    </a>
  </div

  <!-- Tabla de usuarios -->
  <div class="card border-0 rounded-0">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table align-middle table-hover mb-0">
          <thead class="table-success ">
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Roles</th>
              <th>Estado</th>
              <th>Password (hash)</th>
              <th>2FA</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr>
                <td >{{ user.id }}</td>
                <td>{{ user.email }}</td>
                <td>
                  {% for role in user.roles %}
                    <span class="badge bg-success-subtle text-success border">{{ role }}</span>
                  {% else %}
                    <span class="text-muted">Sin roles</span>
                  {% endfor %}
                </td>
                <td>
                  {% if user.isActive %}
                      <span class="badge bg-success">Activo</span>
                  {% else %}
                      <span class="badge bg-danger">Inactivo</span>
                  {% endif %}
                </td>
                <td>
                  <code class="text-muted small">{{ user.password|slice(0,20) ~ '...' }}</code>
                </td>
                <td>
                  {% if user.isGoogleAuthenticatorEnabled %}
                    <span class="text-muted">Si</span>
                  {% else %}
                    No 
                  {% endif %}
                </td>

                <td class="text-center">
                      <div class="btn-group dropup" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        +
                                        </button>
                                        <ul class="dropdown-menu">
                                      
                                        <li><a class="dropdown-item text-muted" href="{{ path('app_user_show', {'id': user.id}) }}"  ><i class="bi bi-eye"></i> Ver</a></li>
                                        <li><a class="dropdown-item text-muted" href="{{ path('app_user_edit', {'id': user.id}) }}" > <i class="bi bi-pencil-square"></i> Editar</a></li>
                                       
                                        </ul>
                        </div>

                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  No hay usuarios registrados.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Paginación -->
  {% if users is not empty %}
    <nav aria-label="Page navigation" class="mt-4">
      <div class="d-flex justify-content-center">
        {{ knp_pagination_render(users, '@KnpPaginator/Pagination/bootstrap_v5_pagination.html.twig') }}  
      </div>
    </nav>
  {% endif %}

</div>
{% endblock %}
#}

{# ==========================================================
   PLANTILLA: templates/user/index.html.twig
   DESCRIPCIÓN:
     Vista principal del módulo de gestión de usuarios.
     Permite listar usuarios registrados en GreenHarvest 
     y buscar dinámicamente por dirección de correo electrónico.

   ARQUITECTURA:
     - Basada en el patrón MVC de Symfony 6.4
     - Se apoya en un controlador "UserController"
       y una ruta "/admin/users"
     - Integra paginación (KnpPaginatorBundle)
     - Búsqueda dinámica AJAX (userSearch.js)
   ========================================================== #}

{% extends 'base.html.twig' %}

{% block title %}Gestión de Usuarios - GreenHarvest{% endblock %}

{% block breadcrumb %}
    {% set breadcrumb = [
        {'label': 'Inicio', 'url': path('app_home')},
        {'label': 'Usuarios'}
    ] %}
    {% include 'components/_breadcrumb.html.twig' with {'items': breadcrumb} %}
{% endblock %}

{% block body %}
<div class="">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 fw-bold text-success mb-0">Usuarios</h1>
  </div>

  <!-- Buscador por Email -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <form method="get"
          action="{{ path('app_user_index') }}"
          class="mb-1">
      <div class="input-group">
        <input type="text" 
               name="find_user"
               id="userSearch"
               value="{{ find_user|default('') }}" 
               class="form-control" 
               placeholder="Buscar usuario por email...">
        <button  class="btn btn-outline-secondary disabled rounded-0">
          <i class="bi bi-search"></i> 
        </button>
      </div>
    </form>
  </div>

  <!-- Contenedor dinámico para los resultados -->
  <div id="userResults">
      {# Incluimos la subvista con la tabla de resultados #}
      {% include 'user/_table.html.twig' with {'users': users} %}
  </div>

</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  {# Archivo JS específico para la búsqueda dinámica de usuarios #}
  <script src="{{ asset('js/modules/user_search.js') }}"></script>
{% endblock %}
